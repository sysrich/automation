def kubicLib = library("kubic-jenkins-library@${env.BRANCH_NAME}").com.suse.kubic

// Configure the build properties
properties([
    buildDiscarder(logRotator(numToKeepStr: '31', daysToKeepStr: '31')),
    disableConcurrentBuilds(),
    // Run every two hours
    pipelineTriggers([cron('H H/2 * * *')]),
])

def kvmTypeOptions = kubicLib.CaaspKvmTypeOptions.new();
kvmTypeOptions.vanilla = true
kvmTypeOptions.channel = 'release'

coreKubicProjectPeriodic(
    environmentTypeOptions: kvmTypeOptions
) {
    // empty preBootstrapBody
} {
    // Install Update Repo
    prepareUpgradeEnvironment(
        environment: environment,
        extraRepos: [
            'SUSE-CAASP-4.0-POOL-x86_64-Media1': 'http://download.suse.de/ibs/SUSE:/SLE-15:/Update:/Products:/CASP40/images/repo/SUSE-CAASP-4.0-POOL-x86_64-Media1/'
        ]
    )

    // Run Transactional Update
    transactionalUpdate(
        environment: environment
    )

    // Run through the upgrade orchestration
    upgradeEnvironmentStage1(
       environment: environment
    )

    stage('Switch Branch') {
       dir('automation') {
          sh(script: "git checkout master")
       }
    }

    upgradeEnvironmentStage2(
       environment: environment
    )

    // Run the Core Project Tests again
    coreKubicProjectTests(
        environment: environment,
        podName: 'default'
    )
}
